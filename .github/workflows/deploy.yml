name: Deploy

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
  workflow_dispatch:
    inputs:
      action:
        description: "Choose deploy or rollback"
        type: choice
        options:
          - deploy
          - rollback
        default: deploy
      target:
        description: "Target environment"
        type: choice
        options:
          - staging
          - production
        default: production

permissions:
  contents: read

concurrency:
  group: deploy-${{ github.event.workflow_run.head_branch || github.ref_name || github.run_id }}
  cancel-in-progress: false

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    environment: staging
    if: >
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       contains(fromJson('["main","master"]'), github.event.workflow_run.head_branch) &&
       !contains(github.event.workflow_run.head_commit.message || '', '[no-deploy]')) ||
      (github.event_name == 'workflow_dispatch' &&
       github.event.inputs.action == 'deploy')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Trigger staging deployment
        env:
          HOOK_URL: ${{ secrets.STAGING_DEPLOY_HOOK_URL }}
        run: |
          if [ -z "$HOOK_URL" ]; then
            echo "Missing secret STAGING_DEPLOY_HOOK_URL"
            exit 1
          fi
          curl -fsS -X POST "$HOOK_URL"

      - name: Smoke test staging
        env:
          APP_URL: ${{ vars.STAGING_APP_URL }}
        run: |
          if [ -z "$APP_URL" ]; then
            echo "Missing repository variable STAGING_APP_URL"
            exit 1
          fi
          ./scripts/smoke-test.sh "$APP_URL"

  lighthouse-staging:
    runs-on: ubuntu-latest
    needs: [deploy-staging]
    environment: staging
    if: needs.deploy-staging.result == 'success'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate staging web URL
        run: |
          if [ -z "${{ vars.STAGING_WEB_URL }}" ]; then
            echo "Missing repository/environment variable STAGING_WEB_URL"
            exit 1
          fi

      - name: Run Lighthouse on staging
        uses: treosh/lighthouse-ci-action@v12
        with:
          urls: |
            ${{ vars.STAGING_WEB_URL }}
          configPath: ./.lighthouserc.json
          uploadArtifacts: true
          temporaryPublicStorage: true

  deploy-production:
    runs-on: ubuntu-latest
    needs: [deploy-staging, lighthouse-staging]
    environment: production
    if: >
      always() &&
      ((github.event_name == 'workflow_run' &&
        github.event.workflow_run.conclusion == 'success' &&
        contains(fromJson('["main","master"]'), github.event.workflow_run.head_branch) &&
        !contains(github.event.workflow_run.head_commit.message || '', '[no-deploy]') &&
        needs.deploy-staging.result == 'success' &&
        needs.lighthouse-staging.result == 'success') ||
       (github.event_name == 'workflow_dispatch' &&
        github.event.inputs.action == 'deploy' &&
        github.event.inputs.target == 'production' &&
        needs.deploy-staging.result == 'success' &&
        needs.lighthouse-staging.result == 'success'))
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Trigger production deployment
        env:
          HOOK_URL: ${{ secrets.PRODUCTION_DEPLOY_HOOK_URL }}
        run: |
          if [ -z "$HOOK_URL" ]; then
            echo "Missing secret PRODUCTION_DEPLOY_HOOK_URL"
            exit 1
          fi
          curl -fsS -X POST "$HOOK_URL"

      - name: Smoke test production
        env:
          APP_URL: ${{ vars.PRODUCTION_APP_URL }}
        run: |
          if [ -z "$APP_URL" ]; then
            echo "Missing repository variable PRODUCTION_APP_URL"
            exit 1
          fi
          ./scripts/smoke-test.sh "$APP_URL"

  rollback:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'rollback'
    environment: ${{ github.event.inputs.target }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select rollback target
        run: |
          if [ "${{ github.event.inputs.target }}" = "production" ]; then
            echo "HOOK_URL=${{ secrets.PRODUCTION_ROLLBACK_HOOK_URL }}" >> "$GITHUB_ENV"
            echo "APP_URL=${{ vars.PRODUCTION_APP_URL }}" >> "$GITHUB_ENV"
          else
            echo "HOOK_URL=${{ secrets.STAGING_ROLLBACK_HOOK_URL }}" >> "$GITHUB_ENV"
            echo "APP_URL=${{ vars.STAGING_APP_URL }}" >> "$GITHUB_ENV"
          fi

      - name: Trigger rollback
        run: |
          if [ -z "${HOOK_URL:-}" ]; then
            echo "Missing rollback hook secret for target environment"
            exit 1
          fi
          curl -fsS -X POST "$HOOK_URL"

      - name: Smoke test after rollback
        run: |
          if [ -z "${APP_URL:-}" ]; then
            echo "Missing app URL variable for target environment"
            exit 1
          fi
          ./scripts/smoke-test.sh "$APP_URL"
